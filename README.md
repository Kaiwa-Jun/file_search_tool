# Next.js × Gemini File Search Tool

## 目的

Gemini の File Search Tool を最小構成で体験し、「ストア作成 → ファイル取り込み → 質問 → 引用付き回答」の一連の流れと注意点を理解する。

学習用の題材として、"Ask the Manual"（1ファイルに質問して答えを得る）を採用。

## 対象・前提

- **フレームワーク**: Next.js（App Router）
- **UI**: 1ページ構成、ログインなし
- **方針**: 学習優先。UIは最小、ライブラリは極力使わない
- **依存**: `@google/genai` のみ（UI系ライブラリは不要）

## ユースケース

1. ユーザーが PDF/Markdown/TXT を1つアップロード
2. 「この手順を要約」「エラー対策は？」など自然言語で質問
3. 回答とともに**引用（出典チャンク）**を画面に表示

## 画面/フロー（最小）

### 画面構成

1ページに「ファイル選択」「質問入力」「送信」ボタン、結果表示領域

### フロー

1. **ファイル選択** → `/api/store` へ送信 → ストア作成＆取り込み → `storeName` 取得
2. **問い合わせ** → `/api/ask` へ質問＋`storeName` → 回答・引用を表示
3. **（任意）ストア削除**ボタンで後片付け

## 機能要件

- ✅ ストア作成・ファイル取り込み（完了までポーリングで待機）
- ✅ 質問実行（`tools.fileSearch` を指定）
- ✅ 回答テキスト表示／引用メタ情報の表示（該当ページや抜粋の識別）
- ✅ 簡易エラーハンドリング（アップロード失敗、インデックス未完了などの文言）

## 非機能要件

- 素早い体験重視（単一ファイル・小さめサイズを想定）
- 依存は `@google/genai` のみ（UI系ライブラリは不要）
- レイテンシ対策：取り込み完了ポーリングは数秒間隔、最大回数を設定

## アーキテクチャ（最小）

### フロント

- Next.js App Router の1ページ
- state: `storeName`, `question`, `answer`, `citations`, `status`

### API ルート

#### `POST /api/store`

- Node.js ランタイムで FormData を受け、`/tmp` に保存
- File Search Store 作成
- ファイル取り込み
- 完了ポーリング
- `storeName` 返却

#### `POST /api/ask`

- `storeName` と `question` を受け取る
- `generateContent` に `tools.fileSearch` を指定して実行
- 回答/引用返却

### サーバ設定

- `GEMINI_API_KEY` をサーバ側環境変数で管理（クライアントへ露出しない）

### ストレージ/DB

- 不要（学習用のため永続化しない）

## セキュリティ/運用の注意

- ✅ APIキーはサーバのみで保持（クライアントに渡さない）
- ✅ アップロードは許可 MIME のみ（pdf/markdown/txt など）を簡易バリデーション
- ✅ `/tmp` の一時ファイルはアップロード後に削除
- ⚠️ 学習用途のため公開デプロイは想定外（ローカル or 制限付き環境）

## 成功基準（受け入れ条件）

- ✅ 任意の1ファイルを取り込み、質問に対して回答＋引用が表示される
- ✅ 失敗時に原因を示す簡易メッセージが出る
- ✅ 追加学習なしで File Search の基本挙動が説明できる

## 今後の拡張アイデア（任意）

- 複数ファイル対応（同一ストアに追加）
- メタデータによる絞り込み
- 簡易セッション管理（直近の `storeName` を保持）
- ストア一覧/削除のメンテナンス画面

## セットアップ

```bash
# 依存関係のインストール
npm install

# 環境変数の設定
cp .env.example .env.local
# .env.local に GEMINI_API_KEY を設定

# 開発サーバー起動
npm run dev
```

## 実装タスク

詳細な実装タスクは [TASKS.md](./TASKS.md) を参照してください。
