# 実装タスク一覧

## 1. プロジェクトセットアップ

### 1.0 Next.js プロジェクトの作成

**重要**: このタスクは、既存のNext.jsプロジェクトがない場合のみ実行してください。  
現在のプロジェクトに `package.json` に `next` が含まれている場合は、このステップはスキップして 1.1 に進んでください。

- [ ] Next.js プロジェクトを新規作成

  ```bash
  npx create-next-app@latest . --typescript --app --no-src-dir --import-alias "@/*"
  ```

  または、既存のディレクトリで初期化する場合：

  ```bash
  npx create-next-app@latest file-search-tool --typescript --app --no-src-dir --import-alias "@/*"
  cd file-search-tool
  ```

- [ ] プロジェクト構造の確認
  - `app/` ディレクトリが存在することを確認
  - `app/page.tsx` が存在することを確認
  - `app/layout.tsx` が存在することを確認

**注意**: このプロジェクトは Next.js App Router を使用します。`pages/` ディレクトリではなく `app/` ディレクトリを使用します。

### 1.1 依存関係の追加

- [ ] `@google/genai` パッケージをインストール

  ```bash
  npm install @google/genai
  ```

### 1.2 環境変数設定

- [ ] `.env.local` ファイルを作成
- [ ] `.env.example` ファイルを作成（テンプレート）
- [ ] `.env.local` に `GEMINI_API_KEY` を設定
- [ ] `.gitignore` に `.env.local` が含まれていることを確認

## 2. API ルート実装: `/api/store`

### 2.1 基本的なエンドポイント作成

- [ ] `app/api/store/route.ts` を作成
- [ ] `POST` メソッドのハンドラーを実装
- [ ] FormData からファイルを取得
- [ ] MIME タイプのバリデーション（pdf, markdown, txt など）

### 2.2 ファイル保存処理

- [ ] `/tmp` ディレクトリに一時ファイルを保存
- [ ] ファイル名の生成（ユニークな名前）
- [ ] ファイル保存のエラーハンドリング

### 2.3 File Search Store 作成

- [ ] `@google/genai` のクライアント初期化
- [ ] `createFileSearchStore` でストアを作成
- [ ] `storeName` の取得と保存

### 2.4 ファイル取り込み

- [ ] 作成したストアにファイルをアップロード
- [ ] アップロード処理のエラーハンドリング

### 2.5 インデックス完了のポーリング

- [ ] ストアの状態を定期的にチェック（数秒間隔）
- [ ] 最大ポーリング回数の設定
- [ ] タイムアウト処理
- [ ] 完了状態の判定

### 2.6 クリーンアップ処理

- [ ] 一時ファイルの削除（`/tmp` のファイル）
- [ ] エラー時のクリーンアップ

### 2.7 レスポンス返却

- [ ] `storeName` を JSON で返却
- [ ] 適切な HTTP ステータスコードの設定

## 3. API ルート実装: `/api/ask`

### 3.1 基本的なエンドポイント作成

- [ ] `app/api/ask/route.ts` を作成
- [ ] `POST` メソッドのハンドラーを実装
- [ ] リクエストボディから `storeName` と `question` を取得
- [ ] 入力値のバリデーション

### 3.2 Gemini API 呼び出し

- [ ] `@google/genai` のクライアント初期化
- [ ] `generateContent` に `tools.fileSearch` を指定
- [ ] `storeName` を指定して File Search を実行
- [ ] 質問の実行とエラーハンドリング

### 3.3 回答と引用の抽出

- [ ] 回答テキストの取得
- [ ] 引用（citations）メタ情報の抽出
- [ ] 引用情報の構造化（ページ番号、抜粋など）

### 3.4 レスポンス返却

- [ ] 回答と引用を JSON で返却
- [ ] 適切な HTTP ステータスコードの設定

## 4. フロントエンド実装

### 4.1 ページコンポーネント作成

- [ ] `app/page.tsx` を作成（または既存を更新）
- [ ] 基本的なレイアウト構造

### 4.2 状態管理

- [ ] `storeName` の状態管理
- [ ] `question` の状態管理
- [ ] `answer` の状態管理
- [ ] `citations` の状態管理
- [ ] `status`（ローディング、エラーなど）の状態管理

### 4.3 ファイル選択UI

- [ ] ファイル選択の `<input type="file">` を実装
- [ ] 選択されたファイル名の表示
- [ ] ファイル選択のバリデーション（UI側）

### 4.4 ストア作成処理

- [ ] `/api/store` への POST リクエスト実装
- [ ] FormData の作成と送信
- [ ] ローディング状態の表示
- [ ] エラーハンドリングとエラーメッセージ表示
- [ ] `storeName` の保存

### 4.5 質問入力UI

- [ ] テキストエリアまたは入力フィールドの実装
- [ ] 質問入力のバリデーション

### 4.6 質問送信処理

- [ ] `/api/ask` への POST リクエスト実装
- [ ] `storeName` と `question` の送信
- [ ] ローディング状態の表示
- [ ] エラーハンドリングとエラーメッセージ表示

### 4.7 回答表示UI

- [ ] 回答テキストの表示領域
- [ ] 引用情報の表示領域
- [ ] 引用の見やすいフォーマット（ページ番号、抜粋など）

### 4.8 ストア削除機能（任意）

- [ ] ストア削除ボタンの実装
- [ ] 削除 API の呼び出し（必要に応じて）
- [ ] 削除後の状態リセット

## 5. エラーハンドリング

### 5.1 API 側のエラーハンドリング

- [ ] ファイルアップロード失敗時のエラーメッセージ
- [ ] ストア作成失敗時のエラーメッセージ
- [ ] インデックス未完了時のエラーメッセージ
- [ ] API キー未設定時のエラーメッセージ
- [ ] ネットワークエラー時のハンドリング

### 5.2 フロント側のエラーハンドリング

- [ ] API エラーレスポンスの表示
- [ ] ネットワークエラーの表示
- [ ] バリデーションエラーの表示
- [ ] ユーザーフレンドリーなエラーメッセージ

## 6. UI/UX 改善

### 6.1 ローディング状態

- [ ] ファイルアップロード中のローディング表示
- [ ] インデックス処理中のローディング表示
- [ ] 質問送信中のローディング表示

### 6.2 ステータス表示

- [ ] 現在の処理状態を表示（「ファイルをアップロード中...」「インデックス作成中...」など）
- [ ] 成功メッセージの表示

### 6.3 基本的なスタイリング

- [ ] 最小限の CSS で見やすくする
- [ ] レスポンシブ対応（必要に応じて）

## 7. 動作確認・テスト

### 7.1 手動テスト

- [ ] PDF ファイルのアップロードと質問
- [ ] Markdown ファイルのアップロードと質問
- [ ] TXT ファイルのアップロードと質問
- [ ] エラーケースの確認（無効なファイル形式、API キー未設定など）

### 7.2 エッジケースの確認

- [ ] 大きなファイルサイズの処理
- [ ] ネットワークエラー時の挙動
- [ ] タイムアウト時の挙動

## 8. ドキュメント整備

### 8.1 README の更新

- [ ] セットアップ手順の確認
- [ ] 使用方法の記載
- [ ] トラブルシューティングの追加（必要に応じて）

### 8.2 コードコメント

- [ ] 重要な処理にコメントを追加
- [ ] API エンドポイントの説明コメント

## 実装の優先順位

1. **最優先**:
   - タスク 1.0（Next.jsプロジェクト作成）※既存プロジェクトがある場合はスキップ
   - タスク 1.1〜1.2（依存関係追加、環境変数設定）
   - タスク 2（`/api/store`）
   - タスク 3（`/api/ask`）
   - タスク 4（フロントエンド基本実装）
2. **次**: タスク 5（エラーハンドリング）、タスク 6（UI/UX 改善）
3. **最後**: タスク 7（動作確認）、タスク 8（ドキュメント整備）

## 実装の流れ（タイミング）

- **タスク 1.0**: プロジェクト作成は最初に実行（既存プロジェクトがある場合はスキップ）
- **タスク 1.1〜1.2**: プロジェクト作成後、すぐに実行
- **タスク 2〜3**: API ルートは、プロジェクトセットアップ完了後に実装
- **タスク 4**: フロントエンドは、API ルートが動作確認できてから実装すると効率的

## 注意事項

- 各タスクは独立して実装・テスト可能なように分割されています
- 実装中に問題が発生した場合は、該当タスクにメモを追加してください
- 完了したタスクはチェックボックスにチェックを入れてください
